<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <title>gateBLE</title>
  <link rel="stylesheet" href="style.css" />
  <script src="ble-client.js"></script>
  <body>
    <div id="stats">
      <div id="not-connected">
        <p>Connect to a BLE device to get started</p>
        <button id="btn-connect" class="btn">Connect</button>
      </div>
      <div id="container" class="hidden">
        <label class="btn-up"><input type="checkbox" id="up" />
          <div></div>
        </label>
        <label class="btn-down"><input type="checkbox" id="down" />  
          <div></div>
        </label>
        <div id="button">
          <button id="btn-disconnect" onclick="disconnect()" class="btn">
            Disconnect
          </button>
        </div>
      </div>
    </div>
    <footer>
      <div>
        Gitner
      </div>
    </footer>
  </body>
</html>
<script>
  /* updates UI when Gate is Opening 
  function handleUpStatusChanged(event) {
    let status = event.target.value.getUint8(0);
    rays = document.getElementsByClassName("rays");

    if (status) {
      for (let ray of rays) {
        ray.style.setProperty("display", "block");
        let up = document.getElementById("up");
      }
      up.checked = true;
    } else {
      for (let ray of rays) {
        ray.style.setProperty("display", "none");
      }
      up.checked = false;
    }
  }
  */

  /* helper function to decode message sent from peripheral */
  function decode(buf) {
    let dec = new TextDecoder("utf-8");
    return dec.decode(buf);
  }

  /* Disconnect from peripheral and update UI */
  function disconnect() {
    gateBLE.disconnect();
    document.getElementById("not-connected").classList.remove("hidden");
    document.getElementById("container").classList.add("hidden");
  }

  var gateBLE = new GateBLE();
  var up = document.getElementById("up");
  var down = document.getElementById("down");
  
  /* connect to peripheral, load data and add event listeners */
  document
    .getElementById("btn-connect")
    .addEventListener("click", async event => {
      try {
        await gateBLE.request();
        await gateBLE.connect();
        await gateBLE.setUpCharacteristic();
        document.getElementById("not-connected").classList.add("hidden");

        up.addEventListener("change", e => {
          if (e.target.checked) {
            gateBLE.writeUp(1);
            up.disabled = true;
            setTimeout(() => {
              up.disabled = false;
            }, 1000);
          } else {
            gateBLE.writeUp(0);
            up.disabled = true;
            setTimeout(() => {
              up.disabled = false;
            }, 1000);
          }
        });

	down.addEventListener("change", e => {
          if (e.target.checked) {
            gateBLE.writeDown(1);
            down.disabled = true;
            setTimeout(() => {
              down.disabled = false;
            }, 1000);
          } else {
            gateBLE.writeDown(0);
            down.disabled = true;
            setTimeout(() => {
              down.disabled = false;
            }, 1000);
          }
        });

        document.getElementById("container").classList.remove("hidden");
      } catch (error) {
        console.log(error.message);
      }
    });
</script>
